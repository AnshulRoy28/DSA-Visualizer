<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickSort Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Bar container */
        .sort-container {
            position: relative;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.4) 100%);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            height: 320px;
            overflow: hidden;
        }

        /* Bar base styling */
        .bar {
            position: absolute;
            bottom: 0;
            border-radius: 6px 6px 0 0;
            transition: left 0.3s ease, background 0.2s, box-shadow 0.2s, transform 0.2s;
            width: 40px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .bar span {
            position: absolute;
            bottom: 8px;
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* State 1: Unsorted/Idle (Gray) */
        .bar-idle {
            background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 0 10px rgba(148, 163, 184, 0.2);
        }

        /* State 2: Pivot (Gold) */
        .bar-pivot {
            background: linear-gradient(180deg, #fcd34d 0%, #f59e0b 100%);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
            transform: scaleX(1.1);
            z-index: 10;
        }

        /* State 3: Active Comparison/Scanning (Blue) */
        .bar-scanning {
            background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        /* State 4: Swap Candidate (Red) */
        .bar-swap {
            background: linear-gradient(180deg, #f87171 0%, #ef4444 100%);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.6);
            transform: scale(1.05);
        }

        /* State 5: Sorted/Locked (Green) */
        .bar-sorted {
            background: linear-gradient(180deg, #4ade80 0%, #22c55e 100%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        /* Pointer indicators */
        .pointer {
            position: absolute;
            top: -30px;
            font-size: 12px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            transform: translateX(-50%);
        }

        .pointer-i {
            background: #3b82f6;
            color: white;
        }

        .pointer-j {
            background: #8b5cf6;
            color: white;
        }

        .pointer-pivot {
            background: #f59e0b;
            color: black;
        }

        /* Pseudocode styling */
        .code-panel {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .code-line {
            padding: 3px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .code-line.active {
            background: rgba(251, 191, 36, 0.3);
            border-left: 3px solid #f59e0b;
        }

        .code-line-number {
            color: #64748b;
            width: 24px;
            display: inline-block;
            text-align: right;
            margin-right: 12px;
        }

        /* Control buttons */
        .btn-control {
            padding: 10px;
            border-radius: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-play {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .btn-pause {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-step {
            background: rgba(71, 85, 105, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .btn-step:hover {
            background: rgba(71, 85, 105, 0.8);
        }

        .btn-step:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Metrics */
        .metric {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Speed slider */
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            cursor: pointer;
        }

        /* Status badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-sorting {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .status-paused {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .status-complete {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        /* Legend */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }
    </style>
</head>

<body class="text-white">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="mb-6">
            <a href="../index.html"
                class="inline-flex items-center gap-2 text-slate-400 hover:text-yellow-400 transition mb-3 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to Home
            </a>
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-2xl bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center text-xl shadow-lg shadow-yellow-500/30">
                    âš¡</div>
                <div>
                    <h1
                        class="text-2xl font-bold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent">
                        QuickSort Visualizer</h1>
                    <p class="text-slate-400 text-xs">Divide & Conquer â€¢ Lomuto Partition â€¢ O(n log n) average</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <!-- Left Panel: Controls & Code -->
            <div class="lg:col-span-4 space-y-4">
                <!-- Controls -->
                <div class="glass-card rounded-2xl p-4">
                    <h2 class="text-sm font-semibold mb-3 text-slate-300">Array Generation</h2>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label class="text-xs text-slate-400">Size</label>
                            <input type="range" id="sizeSlider" min="5" max="20" value="10"
                                class="slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer mt-1">
                            <div class="text-center text-yellow-400 font-mono text-sm" id="sizeValue">10</div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Type</label>
                            <select id="arrayType"
                                class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-sm mt-1 focus:outline-none focus:border-yellow-500">
                                <option value="random">Random</option>
                                <option value="reversed">Reversed (Worst)</option>
                                <option value="nearly">Nearly Sorted</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="generateArray()"
                        class="w-full bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 py-2 rounded-xl font-semibold text-sm transition">Generate
                        New Array</button>
                </div>

                <!-- Playback Controls -->
                <div class="glass-card rounded-2xl p-4">
                    <h2 class="text-sm font-semibold mb-3 text-slate-300">Playback Controls</h2>
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <button id="stepBackBtn" onclick="stepBack()" class="btn-control btn-step w-12 h-12"
                            title="Step Back" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z" />
                            </svg>
                        </button>
                        <button id="playPauseBtn" onclick="togglePlayPause()" class="btn-control btn-play w-14 h-14">
                            <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                            </svg>
                        </button>
                        <button id="stepForwardBtn" onclick="stepForward()" class="btn-control btn-step w-12 h-12"
                            title="Step Forward" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z" />
                            </svg>
                        </button>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-400">Speed</span>
                            <span id="speedValue" class="text-yellow-400 font-mono">1x</span>
                        </div>
                        <input type="range" id="speedSlider" min="0.5" max="5" step="0.5" value="1"
                            class="slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-700/50">
                        <span class="text-slate-400 text-xs">Status</span>
                        <span id="statusBadge" class="status-badge status-ready">Ready</span>
                    </div>
                    <div class="flex items-center gap-3 mt-3">
                        <label class="flex items-center gap-2 text-xs text-slate-400 cursor-pointer">
                            <input type="checkbox" id="audioToggle"
                                class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-yellow-500 focus:ring-yellow-500">
                            <span>ðŸ”Š Audio</span>
                        </label>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="glass-card rounded-2xl p-4">
                    <h2 class="text-sm font-semibold mb-3 text-slate-300">Metrics</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="metric">
                            <div class="text-xs text-slate-400 mb-1">Comparisons</div>
                            <div class="metric-value text-blue-400" id="comparisons">0</div>
                        </div>
                        <div class="metric">
                            <div class="text-xs text-slate-400 mb-1">Swaps</div>
                            <div class="metric-value text-red-400" id="swaps">0</div>
                        </div>
                    </div>
                </div>

                <!-- Pseudocode -->
                <div class="glass-card rounded-2xl p-4">
                    <h2 class="text-sm font-semibold mb-3 text-slate-300">Lomuto Partition</h2>
                    <div class="code-panel bg-slate-900/50 rounded-xl p-3 overflow-x-auto">
                        <div class="code-line" data-line="1"><span class="code-line-number">1</span><span
                                class="text-purple-400">function</span> partition(arr, low, high):</div>
                        <div class="code-line" data-line="2"><span class="code-line-number">2</span> pivot = arr[high]
                        </div>
                        <div class="code-line" data-line="3"><span class="code-line-number">3</span> i = low - 1</div>
                        <div class="code-line" data-line="4"><span class="code-line-number">4</span> <span
                                class="text-purple-400">for</span> j = low <span class="text-purple-400">to</span> high
                            - 1:</div>
                        <div class="code-line" data-line="5"><span class="code-line-number">5</span> <span
                                class="text-purple-400">if</span> arr[j] < pivot:</div>
                                <div class="code-line" data-line="6"><span class="code-line-number">6</span> i++</div>
                                <div class="code-line" data-line="7"><span class="code-line-number">7</span>
                                    swap(arr[i], arr[j])</div>
                                <div class="code-line" data-line="8"><span class="code-line-number">8</span>
                                    swap(arr[i+1], arr[high])</div>
                                <div class="code-line" data-line="9"><span class="code-line-number">9</span> <span
                                        class="text-purple-400">return</span> i + 1</div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="glass-card rounded-2xl p-4">
                        <h2 class="text-sm font-semibold mb-2 text-slate-300">Color Legend</h2>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #94a3b8, #64748b)">
                                </div>Unsorted
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #fcd34d, #f59e0b)">
                                </div>Pivot
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #60a5fa, #3b82f6)">
                                </div>Scanning
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #f87171, #ef4444)">
                                </div>Swap
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #4ade80, #22c55e)">
                                </div>Sorted
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Visualization -->
                <div class="lg:col-span-8">
                    <div class="glass-card rounded-2xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-semibold text-slate-300">Array Visualization</h3>
                            <div id="pointerInfo" class="text-xs text-slate-500 font-mono"></div>
                        </div>
                        <div id="arrayContainer" class="sort-container"></div>
                        <div id="stepInfo" class="mt-3 text-center text-sm text-slate-400 font-mono h-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ===== STATE MANAGEMENT =====
            let array = [];
            let bars = [];
            let stateStack = [];       // For step-back functionality
            let currentStateIndex = -1;
            let isPlaying = false;
            let isPaused = false;
            let isSorting = false;
            let speed = 1;
            let comparisons = 0;
            let swapCount = 0;
            let audioEnabled = false;

            // Audio context for feedback
            let audioCtx = null;
            function initAudio() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            function playTone(freq, duration, type = 'sine') {
                if (!audioEnabled || !audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            }
            const sounds = {
                compare: () => playTone(400, 0.05),
                swap: () => playTone(600, 0.1, 'square'),
                sorted: () => playTone(800, 0.15, 'triangle')
            };

            // DOM Elements
            const container = document.getElementById('arrayContainer');
            const sizeSlider = document.getElementById('sizeSlider');
            const sizeValue = document.getElementById('sizeValue');
            const speedSlider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');
            const arrayType = document.getElementById('arrayType');
            const statusBadge = document.getElementById('statusBadge');
            const comparisonsEl = document.getElementById('comparisons');
            const swapsEl = document.getElementById('swaps');
            const stepInfo = document.getElementById('stepInfo');
            const pointerInfo = document.getElementById('pointerInfo');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            const stepBackBtn = document.getElementById('stepBackBtn');
            const stepForwardBtn = document.getElementById('stepForwardBtn');
            const audioToggle = document.getElementById('audioToggle');

            const BAR_WIDTH = 40;
            const BAR_GAP = 8;

            // Event Listeners
            sizeSlider.addEventListener('input', e => { sizeValue.textContent = e.target.value; if (!isSorting) generateArray(); });
            speedSlider.addEventListener('input', e => { speed = parseFloat(e.target.value); speedValue.textContent = speed + 'x'; });
            audioToggle.addEventListener('change', e => { audioEnabled = e.target.checked; if (audioEnabled) initAudio(); });

            function setStatus(s) {
                statusBadge.className = 'status-badge';
                if (s === 'Ready') { statusBadge.classList.add('status-ready'); statusBadge.textContent = 'Ready'; }
                else if (s === 'Sorting') { statusBadge.classList.add('status-sorting'); statusBadge.textContent = 'Sorting...'; }
                else if (s === 'Paused') { statusBadge.classList.add('status-paused'); statusBadge.textContent = 'Paused'; }
                else { statusBadge.classList.add('status-complete'); statusBadge.textContent = 'Complete'; }
            }

            function highlightCode(lineNum) {
                document.querySelectorAll('.code-line').forEach(el => el.classList.remove('active'));
                if (lineNum) document.querySelector(`.code-line[data-line="${lineNum}"]`)?.classList.add('active');
            }

            function generateArray() {
                if (isSorting) return;
                container.innerHTML = '';
                array = [];
                bars = [];
                stateStack = [];
                currentStateIndex = -1;
                comparisons = 0;
                swapCount = 0;
                comparisonsEl.textContent = '0';
                swapsEl.textContent = '0';
                stepInfo.textContent = '';
                pointerInfo.textContent = '';
                highlightCode(null);

                const size = parseInt(sizeSlider.value);
                const type = arrayType.value;
                const totalWidth = (size * BAR_WIDTH) + ((size - 1) * BAR_GAP);
                const startLeft = (container.offsetWidth - totalWidth) / 2;

                // Generate array based on type
                if (type === 'random') {
                    for (let i = 0; i < size; i++) array.push(Math.floor(Math.random() * 80) + 20);
                } else if (type === 'reversed') {
                    for (let i = size; i > 0; i--) array.push(i * 5 + 10);
                } else { // nearly sorted
                    for (let i = 0; i < size; i++) array.push(i * 5 + 20);
                    // Swap a few random pairs
                    for (let i = 0; i < Math.floor(size / 4); i++) {
                        const a = Math.floor(Math.random() * size);
                        const b = Math.floor(Math.random() * size);
                        [array[a], array[b]] = [array[b], array[a]];
                    }
                }

                // Create bars
                array.forEach((val, i) => {
                    const bar = document.createElement('div');
                    bar.className = 'bar bar-idle';
                    bar.style.height = `${val * 3}px`;
                    bar.style.left = `${startLeft + i * (BAR_WIDTH + BAR_GAP)}px`;
                    const label = document.createElement('span');
                    label.textContent = val;
                    bar.appendChild(label);
                    container.appendChild(bar);
                    bars.push(bar);
                });

                setStatus('Ready');
                updatePlayPauseButton();
                stepBackBtn.disabled = true;
                stepForwardBtn.disabled = true;
            }

            // ===== STATE CAPTURE FOR STEP-THROUGH =====
            function captureState(info, codeLine) {
                const state = {
                    array: [...array],
                    barClasses: bars.map(b => b.className),
                    barPositions: bars.map(b => b.style.left),
                    comparisons,
                    swaps: swapCount,
                    info,
                    codeLine
                };
                // Remove future states if we're stepping back then forward
                if (currentStateIndex < stateStack.length - 1) {
                    stateStack = stateStack.slice(0, currentStateIndex + 1);
                }
                stateStack.push(state);
                currentStateIndex = stateStack.length - 1;
            }

            function restoreState(index) {
                if (index < 0 || index >= stateStack.length) return;
                const state = stateStack[index];
                array = [...state.array];
                bars.forEach((bar, i) => {
                    bar.className = state.barClasses[i];
                    bar.style.left = state.barPositions[i];
                    bar.querySelector('span').textContent = array[i];
                });
                comparisons = state.comparisons;
                swapCount = state.swaps;
                comparisonsEl.textContent = comparisons;
                swapsEl.textContent = swapCount;
                stepInfo.textContent = state.info;
                highlightCode(state.codeLine);
                currentStateIndex = index;
                stepBackBtn.disabled = currentStateIndex <= 0;
                stepForwardBtn.disabled = currentStateIndex >= stateStack.length - 1;
            }

            function stepBack() {
                if (currentStateIndex > 0) {
                    isPaused = true;
                    setStatus('Paused');
                    restoreState(currentStateIndex - 1);
                }
            }

            function stepForward() {
                if (currentStateIndex < stateStack.length - 1) {
                    restoreState(currentStateIndex + 1);
                }
            }

            // ===== PLAYBACK CONTROL =====
            function updatePlayPauseButton() {
                if (isPlaying) {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playPauseBtn.classList.remove('btn-play');
                    playPauseBtn.classList.add('btn-pause');
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    playPauseBtn.classList.remove('btn-pause');
                    playPauseBtn.classList.add('btn-play');
                }
            }

            async function togglePlayPause() {
                if (!isSorting) {
                    // Start sorting
                    startSort();
                } else if (isPlaying) {
                    // Pause
                    isPlaying = false;
                    isPaused = true;
                    setStatus('Paused');
                    updatePlayPauseButton();
                } else {
                    // Resume
                    isPlaying = true;
                    isPaused = false;
                    setStatus('Sorting');
                    updatePlayPauseButton();
                }
            }

            function sleep(ms) {
                return new Promise(resolve => {
                    const checkPause = () => {
                        if (!isPaused) resolve();
                        else setTimeout(checkPause, 50);
                    };
                    setTimeout(checkPause, ms / speed);
                });
            }

            async function waitIfPaused() {
                while (isPaused && isSorting) {
                    await new Promise(r => setTimeout(r, 50));
                }
            }

            // ===== QUICKSORT WITH LOMUTO PARTITION =====
            async function startSort() {
                isSorting = true;
                isPlaying = true;
                isPaused = false;
                stateStack = [];
                currentStateIndex = -1;
                setStatus('Sorting');
                updatePlayPauseButton();
                stepBackBtn.disabled = false;
                stepForwardBtn.disabled = true;

                captureState('Starting QuickSort', null);
                await quickSort(0, array.length - 1);

                // Mark all as sorted
                bars.forEach(b => b.className = 'bar bar-sorted');
                sounds.sorted();
                captureState('QuickSort Complete!', null);

                isSorting = false;
                isPlaying = false;
                setStatus('Complete');
                updatePlayPauseButton();
                highlightCode(null);
                stepInfo.textContent = 'QuickSort Complete!';
            }

            async function quickSort(low, high) {
                if (low < high) {
                    await waitIfPaused();
                    const pi = await partition(low, high);
                    await quickSort(low, pi - 1);
                    await quickSort(pi + 1, high);
                } else if (low === high && low >= 0 && low < bars.length) {
                    bars[low].className = 'bar bar-sorted';
                    sounds.sorted();
                    captureState(`Element ${array[low]} is in final position`, 9);
                }
            }

            async function partition(low, high) {
                const pivot = array[high];
                bars[high].className = 'bar bar-pivot';
                highlightCode(2);
                stepInfo.textContent = `Pivot selected: ${pivot}`;
                captureState(`Pivot = ${pivot} (index ${high})`, 2);
                await sleep(500);

                let i = low - 1;
                highlightCode(3);
                captureState(`i = ${i}`, 3);
                await sleep(300);

                for (let j = low; j < high; j++) {
                    await waitIfPaused();

                    // Highlight j (scanning)
                    highlightCode(4);
                    bars[j].className = 'bar bar-scanning';
                    pointerInfo.textContent = `i = ${i}, j = ${j}`;
                    stepInfo.textContent = `Scanning: arr[${j}] = ${array[j]}`;
                    captureState(`Scanning j = ${j}, arr[j] = ${array[j]}`, 4);
                    sounds.compare();
                    comparisons++;
                    comparisonsEl.textContent = comparisons;
                    await sleep(400);

                    // Compare
                    highlightCode(5);
                    captureState(`Comparing ${array[j]} < ${pivot}?`, 5);
                    await sleep(300);

                    if (array[j] < pivot) {
                        i++;
                        highlightCode(6);
                        captureState(`${array[j]} < ${pivot}, increment i to ${i}`, 6);
                        await sleep(200);

                        if (i !== j) {
                            // Mark swap candidates
                            bars[i].className = 'bar bar-swap';
                            bars[j].className = 'bar bar-swap';
                            highlightCode(7);
                            stepInfo.textContent = `Swap: arr[${i}] â†” arr[${j}]`;
                            captureState(`Swapping arr[${i}]=${array[i]} with arr[${j}]=${array[j]}`, 7);
                            sounds.swap();
                            await sleep(400);

                            // Perform swap
                            await swapBars(i, j);
                            [array[i], array[j]] = [array[j], array[i]];
                            swapCount++;
                            swapsEl.textContent = swapCount;
                        }

                        // Reset i to scanning color (it's part of smaller partition)
                        bars[i].className = 'bar bar-idle';
                    }

                    // Reset j unless it's the pivot
                    if (j !== high) bars[j].className = 'bar bar-idle';
                    await sleep(200);
                }

                // Final pivot swap
                await waitIfPaused();
                if (i + 1 !== high) {
                    bars[i + 1].className = 'bar bar-swap';
                    bars[high].className = 'bar bar-swap';
                    highlightCode(8);
                    stepInfo.textContent = `Place pivot: arr[${i + 1}] â†” arr[${high}]`;
                    captureState(`Placing pivot at index ${i + 1}`, 8);
                    sounds.swap();
                    await sleep(400);

                    await swapBars(i + 1, high);
                    [array[i + 1], array[high]] = [array[high], array[i + 1]];
                    swapCount++;
                    swapsEl.textContent = swapCount;
                }

                // Mark pivot position as sorted
                bars[i + 1].className = 'bar bar-sorted';
                sounds.sorted();
                highlightCode(9);
                stepInfo.textContent = `Pivot ${array[i + 1]} is now at correct position ${i + 1}`;
                captureState(`Partition complete, pivot at index ${i + 1}`, 9);
                pointerInfo.textContent = '';
                await sleep(300);

                return i + 1;
            }

            async function swapBars(i1, i2) {
                const left1 = bars[i1].style.left;
                const left2 = bars[i2].style.left;
                bars[i1].style.left = left2;
                bars[i2].style.left = left1;
                [bars[i1], bars[i2]] = [bars[i2], bars[i1]];
                await sleep(300);
            }

            // Initialize
            window.addEventListener('resize', () => { if (!isSorting) generateArray(); });
            generateArray();
        </script>
</body>

</html>