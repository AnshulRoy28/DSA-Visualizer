<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MergeSort Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .sort-container {
            position: relative;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.4) 100%);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            height: 280px;
            overflow: hidden;
        }

        .bar {
            position: absolute;
            bottom: 0;
            border-radius: 6px 6px 0 0;
            transition: left 0.3s ease, background 0.2s, transform 0.2s;
            width: 36px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .bar span {
            position: absolute;
            bottom: 8px;
            color: white;
            font-weight: 600;
            font-size: 10px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* State colors */
        .bar-idle {
            background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 0 10px rgba(148, 163, 184, 0.2);
        }

        .bar-left {
            background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .bar-right {
            background: linear-gradient(180deg, #f472b6 0%, #ec4899 100%);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.4);
        }

        .bar-comparing {
            background: linear-gradient(180deg, #fcd34d 0%, #f59e0b 100%);
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.5);
            transform: scaleY(1.02);
        }

        .bar-merging {
            background: linear-gradient(180deg, #c084fc 0%, #a855f7 100%);
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.5);
        }

        .bar-sorted {
            background: linear-gradient(180deg, #4ade80 0%, #22c55e 100%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        .code-panel {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            line-height: 1.5;
        }

        .code-line {
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .code-line.active {
            background: rgba(139, 92, 246, 0.3);
            border-left: 3px solid #8b5cf6;
        }

        .code-line-number {
            color: #64748b;
            width: 20px;
            display: inline-block;
            text-align: right;
            margin-right: 8px;
        }

        .btn-control {
            padding: 10px;
            border-radius: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-play {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .btn-pause {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-step {
            background: rgba(71, 85, 105, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .btn-step:hover {
            background: rgba(71, 85, 105, 0.8);
        }

        .btn-step:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .metric {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            cursor: pointer;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-sorting {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }

        .status-paused {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .status-complete {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .depth-bar {
            height: 4px;
            border-radius: 2px;
            background: rgba(139, 92, 246, 0.3);
            margin-top: 8px;
        }

        .depth-fill {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
            transition: width 0.3s;
        }
    </style>
</head>

<body class="text-white">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="mb-4">
            <a href="../index.html"
                class="inline-flex items-center gap-2 text-slate-400 hover:text-purple-400 transition mb-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to Home
            </a>
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-lg shadow-lg shadow-purple-500/30">
                    ðŸ”€</div>
                <div>
                    <h1
                        class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        MergeSort Visualizer</h1>
                    <p class="text-slate-400 text-xs">Divide & Conquer â€¢ O(n log n) guaranteed</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div class="lg:col-span-4 space-y-3">
                <!-- Controls -->
                <div class="glass-card rounded-xl p-3">
                    <h2 class="text-xs font-semibold mb-2 text-slate-300">Array Generation</h2>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div>
                            <label class="text-xs text-slate-400">Size</label>
                            <input type="range" id="sizeSlider" min="4" max="16" value="8"
                                class="slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer mt-1">
                            <div class="text-center text-purple-400 font-mono text-xs" id="sizeValue">8</div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Type</label>
                            <select id="arrayType"
                                class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-2 py-1.5 text-xs mt-1">
                                <option value="random">Random</option>
                                <option value="reversed">Reversed</option>
                                <option value="nearly">Nearly Sorted</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="generateArray()"
                        class="w-full bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 py-2 rounded-lg font-semibold text-xs transition">Generate
                        New Array</button>
                </div>

                <!-- Playback -->
                <div class="glass-card rounded-xl p-3">
                    <h2 class="text-xs font-semibold mb-2 text-slate-300">Playback</h2>
                    <div class="flex items-center justify-center gap-2 mb-3">
                        <button id="stepBackBtn" onclick="stepBack()" class="btn-control btn-step w-10 h-10" disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z" />
                            </svg>
                        </button>
                        <button id="playPauseBtn" onclick="togglePlayPause()" class="btn-control btn-play w-12 h-12">
                            <svg id="playIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                            </svg>
                        </button>
                        <button id="stepForwardBtn" onclick="stepForward()" class="btn-control btn-step w-10 h-10"
                            disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-slate-400">Speed</span>
                        <span id="speedValue" class="text-purple-400 font-mono">1x</span>
                    </div>
                    <input type="range" id="speedSlider" min="0.5" max="5" step="0.5" value="1"
                        class="slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-700/50">
                        <span class="text-slate-400 text-xs">Status</span>
                        <span id="statusBadge" class="status-badge status-ready">Ready</span>
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <label class="flex items-center gap-2 text-xs text-slate-400 cursor-pointer">
                            <input type="checkbox" id="audioToggle" class="w-3 h-3 rounded">
                            <span>ðŸ”Š Audio</span>
                        </label>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mt-2">
                            <span class="text-slate-400">Recursion Depth</span>
                            <span id="depthValue" class="text-purple-400 font-mono">0</span>
                        </div>
                        <div class="depth-bar">
                            <div id="depthFill" class="depth-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="glass-card rounded-xl p-3">
                    <h2 class="text-xs font-semibold mb-2 text-slate-300">Metrics</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="metric">
                            <div class="text-xs text-slate-400">Comparisons</div>
                            <div class="metric-value text-blue-400" id="comparisons">0</div>
                        </div>
                        <div class="metric">
                            <div class="text-xs text-slate-400">Merges</div>
                            <div class="metric-value text-purple-400" id="merges">0</div>
                        </div>
                    </div>
                </div>

                <!-- Pseudocode -->
                <div class="glass-card rounded-xl p-3">
                    <h2 class="text-xs font-semibold mb-2 text-slate-300">Algorithm</h2>
                    <div class="code-panel bg-slate-900/50 rounded-lg p-2 overflow-x-auto">
                        <div class="code-line" data-line="1"><span class="code-line-number">1</span><span
                                class="text-purple-400">fn</span> mergeSort(arr, l, r):</div>
                        <div class="code-line" data-line="2"><span class="code-line-number">2</span> <span
                                class="text-purple-400">if</span> l < r:</div>
                                <div class="code-line" data-line="3"><span class="code-line-number">3</span> m = (l + r)
                                    / 2</div>
                                <div class="code-line" data-line="4"><span class="code-line-number">4</span>
                                    mergeSort(arr, l, m)</div>
                                <div class="code-line" data-line="5"><span class="code-line-number">5</span>
                                    mergeSort(arr, m+1, r)</div>
                                <div class="code-line" data-line="6"><span class="code-line-number">6</span> merge(arr,
                                    l, m, r)</div>
                                <div class="code-line" data-line="7"><span class="code-line-number">7</span><span
                                        class="text-purple-400">fn</span> merge(arr, l, m, r):</div>
                                <div class="code-line" data-line="8"><span class="code-line-number">8</span> <span
                                        class="text-slate-500">// compare & merge</span></div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="glass-card rounded-xl p-3">
                        <h2 class="text-xs font-semibold mb-2 text-slate-300">Legend</h2>
                        <div class="grid grid-cols-3 gap-1">
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #60a5fa, #3b82f6)">
                                </div>Left
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #f472b6, #ec4899)">
                                </div>Right
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #fcd34d, #f59e0b)">
                                </div>Compare
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #c084fc, #a855f7)">
                                </div>Merging
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(180deg, #4ade80, #22c55e)">
                                </div>Sorted
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xs font-semibold text-slate-300">Array Visualization</h3>
                            <div id="rangeInfo" class="text-xs text-slate-500 font-mono"></div>
                        </div>
                        <div id="arrayContainer" class="sort-container"></div>
                        <div id="stepInfo" class="mt-2 text-center text-xs text-slate-400 font-mono h-5"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let array = [], bars = [], stateStack = [], currentStateIndex = -1;
            let isPlaying = false, isPaused = false, isSorting = false, speed = 1;
            let comparisons = 0, mergeCount = 0, maxDepth = 0, audioEnabled = false;
            let audioCtx = null;

            function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
            function playTone(freq, dur, type = 'sine') {
                if (!audioEnabled || !audioCtx) return;
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = freq; o.type = type;
                g.gain.setValueAtTime(0.08, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
                o.start(); o.stop(audioCtx.currentTime + dur);
            }
            const sounds = { compare: () => playTone(440, 0.05), merge: () => playTone(550, 0.08), sorted: () => playTone(700, 0.12) };

            const container = document.getElementById('arrayContainer');
            const sizeSlider = document.getElementById('sizeSlider'), sizeValue = document.getElementById('sizeValue');
            const speedSlider = document.getElementById('speedSlider'), speedValue = document.getElementById('speedValue');
            const arrayType = document.getElementById('arrayType'), statusBadge = document.getElementById('statusBadge');
            const comparisonsEl = document.getElementById('comparisons'), mergesEl = document.getElementById('merges');
            const stepInfo = document.getElementById('stepInfo'), rangeInfo = document.getElementById('rangeInfo');
            const depthValue = document.getElementById('depthValue'), depthFill = document.getElementById('depthFill');
            const playIcon = document.getElementById('playIcon'), pauseIcon = document.getElementById('pauseIcon');
            const stepBackBtn = document.getElementById('stepBackBtn'), stepForwardBtn = document.getElementById('stepForwardBtn');
            const audioToggle = document.getElementById('audioToggle');

            const BAR_WIDTH = 36, BAR_GAP = 6;

            sizeSlider.addEventListener('input', e => { sizeValue.textContent = e.target.value; if (!isSorting) generateArray(); });
            speedSlider.addEventListener('input', e => { speed = parseFloat(e.target.value); speedValue.textContent = speed + 'x'; });
            audioToggle.addEventListener('change', e => { audioEnabled = e.target.checked; if (audioEnabled) initAudio(); });

            function setStatus(s) {
                statusBadge.className = 'status-badge';
                statusBadge.classList.add(s === 'Ready' ? 'status-ready' : s === 'Sorting' ? 'status-sorting' : s === 'Paused' ? 'status-paused' : 'status-complete');
                statusBadge.textContent = s === 'Sorting' ? 'Sorting...' : s;
            }

            function highlightCode(line) {
                document.querySelectorAll('.code-line').forEach(el => el.classList.remove('active'));
                if (line) document.querySelector(`.code-line[data-line="${line}"]`)?.classList.add('active');
            }

            function updateDepth(d) {
                depthValue.textContent = d;
                const pct = maxDepth > 0 ? (d / maxDepth) * 100 : 0;
                depthFill.style.width = pct + '%';
            }

            function generateArray() {
                if (isSorting) return;
                container.innerHTML = ''; array = []; bars = []; stateStack = []; currentStateIndex = -1;
                comparisons = 0; mergeCount = 0; maxDepth = 0;
                comparisonsEl.textContent = '0'; mergesEl.textContent = '0';
                stepInfo.textContent = ''; rangeInfo.textContent = ''; highlightCode(null); updateDepth(0);

                const size = parseInt(sizeSlider.value), type = arrayType.value;
                maxDepth = Math.ceil(Math.log2(size));
                const totalWidth = (size * BAR_WIDTH) + ((size - 1) * BAR_GAP);
                const startLeft = (container.offsetWidth - totalWidth) / 2;

                if (type === 'random') for (let i = 0; i < size; i++) array.push(Math.floor(Math.random() * 80) + 20);
                else if (type === 'reversed') for (let i = size; i > 0; i--) array.push(i * 5 + 15);
                else { for (let i = 0; i < size; i++) array.push(i * 6 + 20); for (let i = 0; i < 2; i++) { const a = Math.floor(Math.random() * size), b = Math.floor(Math.random() * size);[array[a], array[b]] = [array[b], array[a]]; } }

                array.forEach((val, i) => {
                    const bar = document.createElement('div');
                    bar.className = 'bar bar-idle';
                    bar.style.height = `${val * 2.5}px`;
                    bar.style.left = `${startLeft + i * (BAR_WIDTH + BAR_GAP)}px`;
                    const label = document.createElement('span'); label.textContent = val;
                    bar.appendChild(label); container.appendChild(bar); bars.push(bar);
                });
                setStatus('Ready'); updatePlayPauseBtn(); stepBackBtn.disabled = true; stepForwardBtn.disabled = true;
            }

            function captureState(info, codeLine) {
                const state = { array: [...array], barClasses: bars.map(b => b.className), barPositions: bars.map(b => b.style.left), comparisons, merges: mergeCount, info, codeLine };
                if (currentStateIndex < stateStack.length - 1) stateStack = stateStack.slice(0, currentStateIndex + 1);
                stateStack.push(state); currentStateIndex = stateStack.length - 1;
            }

            function restoreState(idx) {
                if (idx < 0 || idx >= stateStack.length) return;
                const s = stateStack[idx];
                array = [...s.array];
                bars.forEach((bar, i) => { bar.className = s.barClasses[i]; bar.style.left = s.barPositions[i]; bar.querySelector('span').textContent = array[i]; });
                comparisons = s.comparisons; mergeCount = s.merges;
                comparisonsEl.textContent = comparisons; mergesEl.textContent = mergeCount;
                stepInfo.textContent = s.info; highlightCode(s.codeLine);
                currentStateIndex = idx;
                stepBackBtn.disabled = currentStateIndex <= 0;
                stepForwardBtn.disabled = currentStateIndex >= stateStack.length - 1;
            }

            function stepBack() { if (currentStateIndex > 0) { isPaused = true; setStatus('Paused'); restoreState(currentStateIndex - 1); } }
            function stepForward() { if (currentStateIndex < stateStack.length - 1) restoreState(currentStateIndex + 1); }

            function updatePlayPauseBtn() {
                if (isPlaying) { playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); document.getElementById('playPauseBtn').classList.replace('btn-play', 'btn-pause'); }
                else { playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); document.getElementById('playPauseBtn').classList.replace('btn-pause', 'btn-play'); }
            }

            async function togglePlayPause() {
                if (!isSorting) startSort();
                else if (isPlaying) { isPlaying = false; isPaused = true; setStatus('Paused'); updatePlayPauseBtn(); }
                else { isPlaying = true; isPaused = false; setStatus('Sorting'); updatePlayPauseBtn(); }
            }

            function sleep(ms) { return new Promise(r => { const check = () => { if (!isPaused) r(); else setTimeout(check, 50); }; setTimeout(check, ms / speed); }); }
            async function waitIfPaused() { while (isPaused && isSorting) await new Promise(r => setTimeout(r, 50)); }

            async function startSort() {
                isSorting = true; isPlaying = true; isPaused = false;
                stateStack = []; currentStateIndex = -1;
                setStatus('Sorting'); updatePlayPauseBtn();
                stepBackBtn.disabled = false; stepForwardBtn.disabled = true;
                captureState('Starting MergeSort', null);
                await mergeSort(0, array.length - 1, 0);
                bars.forEach(b => b.className = 'bar bar-sorted'); sounds.sorted();
                captureState('MergeSort Complete!', null);
                isSorting = false; isPlaying = false; setStatus('Complete'); updatePlayPauseBtn(); highlightCode(null);
                stepInfo.textContent = 'MergeSort Complete!';
            }

            async function mergeSort(l, r, depth) {
                updateDepth(depth);
                if (l < r) {
                    await waitIfPaused();
                    highlightCode(2); captureState(`Dividing [${l}..${r}]`, 2);

                    // Color left half blue, right half pink
                    const m = Math.floor((l + r) / 2);
                    highlightCode(3);
                    for (let i = l; i <= m; i++) bars[i].className = 'bar bar-left';
                    for (let i = m + 1; i <= r; i++) bars[i].className = 'bar bar-right';
                    rangeInfo.textContent = `Left: [${l}..${m}] | Right: [${m + 1}..${r}]`;
                    stepInfo.textContent = `Divide at mid = ${m}`;
                    captureState(`mid = ${m}`, 3);
                    await sleep(400);

                    highlightCode(4); captureState(`Recurse left [${l}..${m}]`, 4);
                    await mergeSort(l, m, depth + 1);

                    highlightCode(5); captureState(`Recurse right [${m + 1}..${r}]`, 5);
                    await mergeSort(m + 1, r, depth + 1);

                    highlightCode(6);
                    await merge(l, m, r);
                    updateDepth(depth);
                } else if (l === r) {
                    bars[l].className = 'bar bar-sorted';
                    captureState(`Single element [${l}] sorted`, 2);
                    await sleep(150);
                }
            }

            async function merge(l, m, r) {
                await waitIfPaused();
                highlightCode(7);
                stepInfo.textContent = `Merging [${l}..${m}] and [${m + 1}..${r}]`;
                rangeInfo.textContent = `Merging...`;
                captureState(`Merge [${l}..${r}]`, 7);
                mergeCount++; mergesEl.textContent = mergeCount;

                const left = array.slice(l, m + 1), right = array.slice(m + 1, r + 1);
                let i = 0, j = 0, k = l;

                while (i < left.length && j < right.length) {
                    await waitIfPaused();
                    highlightCode(8);
                    bars[l + i].className = 'bar bar-comparing';
                    bars[m + 1 + j].className = 'bar bar-comparing';
                    sounds.compare(); comparisons++; comparisonsEl.textContent = comparisons;
                    captureState(`Compare ${left[i]} vs ${right[j]}`, 8);
                    await sleep(350);

                    if (left[i] <= right[j]) {
                        array[k] = left[i];
                        bars[k].className = 'bar bar-merging';
                        bars[k].querySelector('span').textContent = array[k];
                        sounds.merge(); i++;
                    } else {
                        array[k] = right[j];
                        bars[k].className = 'bar bar-merging';
                        bars[k].querySelector('span').textContent = array[k];
                        sounds.merge(); j++;
                    }
                    captureState(`Place ${array[k]} at index ${k}`, 8);
                    await sleep(250);
                    k++;
                }

                while (i < left.length) {
                    array[k] = left[i];
                    bars[k].className = 'bar bar-merging';
                    bars[k].querySelector('span').textContent = array[k];
                    sounds.merge(); i++; k++;
                    await sleep(200);
                }
                while (j < right.length) {
                    array[k] = right[j];
                    bars[k].className = 'bar bar-merging';
                    bars[k].querySelector('span').textContent = array[k];
                    sounds.merge(); j++; k++;
                    await sleep(200);
                }

                // Mark merged section as sorted
                for (let x = l; x <= r; x++) bars[x].className = 'bar bar-sorted';
                sounds.sorted();
                captureState(`Merged [${l}..${r}]`, 7);
                await sleep(300);
            }

            window.addEventListener('resize', () => { if (!isSorting) generateArray(); });
            generateArray();
        </script>
</body>

</html>